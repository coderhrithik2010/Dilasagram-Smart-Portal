<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Principal Dashboard - DCS</title>
  <link rel="stylesheet" href="style.css">

  <!-- ✅ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- ✅ Firebase config -->
  <script src="firebase.js"></script>

  <!-- ✅ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header class="topbar">
    <img src="logo.png" alt="Logo">
    <h2>Principal Dashboard</h2>
  </header>

 <main class="container">
  <section class="card">
    <h3>Class Performance Overview</h3>
    <select id="classDropdown"></select>
    <select id="examDropdown">
      <option value="">-- Select Exam --</option>
      <option>PeriodicTest1</option>
      <option>HalfYearly</option>
      <option>PeriodicTest3</option>
      <option>Annual</option>
    </select>
    <canvas id="principalChart" width="500" height="250"></canvas>
  </section>

  <section class="card">
    <h3>Complaints Management</h3>
    <div id="complaintsTable"></div>
  </section>

  <section class="card">
    <h3>Class Timetable</h3>
    <div id="timetableView"></div>
  </section>

  <section class="card">
    <h3>Activity Photos</h3>
    <div id="photoGallery"></div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const classSelect = document.getElementById("classSelect");
  for (let i = 1; i <= 10; i++) {
    const secs = (i === 8) ? ['A','B','C','D'] : ['A','B','C'];
    secs.forEach(sec => {
      const opt = document.createElement("option");
      opt.value = `class${i}${sec}`;
      opt.textContent = `Class ${i}${sec}`;
      classSelect.appendChild(opt);
    });
  }

  const chartCtx = document.getElementById("chart");
  let chart;

  classSelect.onchange = () => {
    const cls = classSelect.value;
    loadMarks(cls);
    loadComplaints(cls);
    loadTimetable(cls);
    loadPhotos(cls);
  };

  function loadMarks(cls) {
    const ref = db.ref(`schools/dilasagram/classes/${cls}/marks/Annual`);
    ref.once("value", snap => {
      const data = snap.val() || {};
      const names = Object.keys(data);
      const averages = names.map(n => {
        const subs = Object.values(data[n]);
        return subs.reduce((a,b)=>a+b,0)/subs.length;
      });
      if (chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type: "bar",
        data: { labels: names, datasets: [{ label: "Average (%)", data: averages, backgroundColor: "#007bff" }] },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    });
  }

  function loadComplaints(cls) {
    const ref = db.ref(`schools/dilasagram/classes/${cls}/complaints`);
    ref.on("value", snap => {
      const data = snap.val() || {};
      let html = `<table border="1" style="width:100%;border-collapse:collapse">
      <tr><th>Teacher</th><th>Complaint</th><th>Status</th><th>Action</th></tr>`;
      for (let id in data) {
        const c = data[id];
        html += `<tr><td>${c.teacher}</td><td>${c.text}</td><td>${c.status}</td>
        <td>
          <button onclick="resolve('${cls}','${id}')">Resolve</button>
          <button onclick="deleteComplaint('${cls}','${id}')">Delete</button>
        </td></tr>`;
      }
      html += "</table>";
      document.getElementById("complaintsTable").innerHTML = html;
    });
  }

  function resolve(cls, id) {
    db.ref(`schools/dilasagram/classes/${cls}/complaints/${id}`).update({ status: "Resolved" });
  }
  function deleteComplaint(cls, id) {
    if (confirm("Delete complaint?"))
      db.ref(`schools/dilasagram/classes/${cls}/complaints/${id}`).remove();
  }

  function loadTimetable(cls) {
    db.ref(`schools/dilasagram/classes/${cls}/timetable`).on("value", snap => {
      const data = snap.val() || {};
      let html = "<ul>";
      Object.entries(data).forEach(([p,v]) => { html += `<li>${p}: ${v}</li>`; });
      html += "</ul>";
      document.getElementById("timetableView").innerHTML = html;
    });
  }

  function loadPhotos(cls) {
    db.ref(`schools/dilasagram/classes/${cls}/activities`).on("value", snap => {
      const data = snap.val() || {};
      const gallery = document.getElementById("photoGallery");
      gallery.innerHTML = "";
      Object.values(data).forEach(img => {
        const im = document.createElement("img");
        im.src = img.url;
        im.style = "width:100px;border-radius:10px;margin:5px;";
        gallery.appendChild(im);
      });
    });
  }
</script>

  </main>
  <footer class="footer"><a href="index.html" class="btn">Logout</a></footer>
  <script>
  console.log("✅ Principal Dashboard script running");

  const classDrop = document.getElementById("classDropdown");
  const examDrop = document.getElementById("examDropdown");

  // Populate classes dynamically
  for (let i = 1; i <= 10; i++) {
    const secs = i === 8 ? ["A","B","C","D"] : ["A","B","C"];
    secs.forEach(s => {
      const opt = document.createElement("option");
      opt.value = `class${i}${s}`;
      opt.textContent = `Class ${i}${s}`;
      classDrop.appendChild(opt);
    });
  }

  let principalChart;

  function loadClassPerformance() {
    const cls = classDrop.value;
    const exam = examDrop.value;
    if (!cls || !exam) {
      console.log("⚠️ Please select class and exam");
      return;
    }

    console.log(`Fetching data for ${cls}, ${exam}...`);
    const ref = db.ref(`schools/dilasagram/classes/${cls}/marks/${exam}`);

    ref.once("value").then((snap) => {
      const data = snap.val();
      if (!data) {
        alert("No marks data found for this class and exam");
        return;
      }

      const ctx = document.getElementById("principalChart").getContext("2d");
      const students = Object.keys(data);
      const averages = students.map(name => {
        const subs = Object.values(data[name]);
        const total = subs.reduce((a, b) => a + b, 0);
        return (total / (subs.length * 100)) * 100;
      });

      if (principalChart) principalChart.destroy();

      principalChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: students,
          datasets: [{
            label: `${cls} – ${exam} %`,
            data: averages,
            backgroundColor: students.map(() => `hsl(${Math.random() * 360},70%,60%)`)
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 100 } },
          plugins: {
            title: { display: true, text: `${cls} ${exam} Marks %` },
            legend: { display: false }
          }
        }
      });
    }).catch(err => {
      console.error("❌ Firebase read failed:", err);
      alert("Error loading data. Check console.");
    });
  }

  classDrop.addEventListener("change", loadClassPerformance);
  examDrop.addEventListener("change", loadClassPerformance);
</script>
</body>
</html>


