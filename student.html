<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dilasagram Convent School | Student Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="firebase.js"></script>
</head>

<body>
  <header>
    <h1>Dilasagram Convent School</h1>
    <h2>Student Dashboard</h2>
  </header>

  <main class="container">
    <h3 id="studentInfo">Loading...</h3>

    <!-- Marks Section -->
    <section class="card">
      <h3>My Exam Results</h3>
      <select id="examSelect">
        <option value="">-- Select Exam --</option>
        <option>PeriodicTest1</option>
        <option>HalfYearly</option>
        <option>PeriodicTest3</option>
        <option>Annual</option>
      </select>
      <div id="marksTable"></div>
    </section>

    <!-- Timetable Section -->
    <section class="card">
      <h3>Class Timetable</h3>
      <div id="timetableView"></div>
    </section>

    <!-- Attendance -->
    <section class="card">
      <h3>Attendance Record</h3>
      <div id="attendanceView"></div>
    </section>

    <!-- Public Gallery -->
    <section class="card">
      <h3>School Activities Gallery</h3>
      <div id="gallery"></div>
    </section>
  </main>

  <footer class="footer">Â© 2025 Dilasagram Convent School</footer>

  <script>
    // === Load URL Params ===
    const params = new URLSearchParams(window.location.search);
    const className = params.get("class");
    const studentId = params.get("id");

    document.getElementById("studentInfo").innerText =
      `Student: ${studentId} | Class: ${className}`;

    // === Firebase References ===
    const marksRef = db.ref(`schools/dilasagram/classes/${className}/marks`);
    const timetableRef = db.ref(`schools/dilasagram/classes/${className}/timetable`);
    const attendanceRef = db.ref(`schools/dilasagram/classes/${className}/attendance`);
    const galleryRef = db.ref(`schools/dilasagram/public/gallery`);

    // === MARKS ===
    const examSelect = document.getElementById("examSelect");
    const marksTable = document.getElementById("marksTable");

    examSelect.onchange = () => {
      const exam = examSelect.value;
      if (!exam) return (marksTable.innerHTML = "");
      marksRef.child(exam).once("value", (snap) => {
        const allMarks = snap.val() || {};
        const marks = allMarks[studentId];
        if (!marks) {
          marksTable.innerHTML = "<p>No marks available for this exam.</p>";
          return;
        }
        let html = `<table border='1' style='width:100%;border-collapse:collapse'>
          <tr><th>Subject</th><th>Marks</th></tr>`;
        let total = 0, count = 0;
        for (let subj in marks) {
          html += `<tr><td>${subj}</td><td>${marks[subj]}</td></tr>`;
          total += marks[subj]; count++;
        }
        const avg = (total / count).toFixed(2);
        html += `<tr><th>Average</th><th>${avg}%</th></tr></table>`;
        marksTable.innerHTML = html;
      });
    };

    // === TIMETABLE ===
    timetableRef.on("value", (snap) => {
      const data = snap.val() || {};
      let html = "<ul>";
      Object.entries(data).forEach(([p, v]) => (html += `<li>${p}: ${v}</li>`));
      html += "</ul>";
      document.getElementById("timetableView").innerHTML = html;
    });

    // === ATTENDANCE ===
    attendanceRef.on("value", (snap) => {
      const data = snap.val() || {};
      let html = "<ul>";
      Object.entries(data).forEach(([date, students]) => {
        const status = students[studentId];
        if (status)
          html += `<li>${date}: ${status}</li>`;
      });
      html += "</ul>";
      document.getElementById("attendanceView").innerHTML = html;
    });

    // === GALLERY ===
    galleryRef.on("value", (snap) => {
      const data = snap.val() || {};
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";
      Object.values(data).forEach((img) => {
        const im = document.createElement("img");
        im.src = img.url;
        im.style = "width:100px;border-radius:10px;margin:5px;";
        gallery.appendChild(im);
      });
    });
  </script>
</body>
</html>
