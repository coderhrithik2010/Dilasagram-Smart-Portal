<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teacher Panel - DCS</title>
  <link rel="stylesheet" href="style.css">
    <!-- ‚úÖ Firebase SDKs (must be before your custom scripts) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- ‚úÖ Your Firebase config file -->
  <script src="firebase.js"></script>
  <!-- ‚úÖ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="topbar">
    <img src="logo.png" alt="Logo">
    <h2>Teacher Panel</h2>
  </header>

  <main class="container">
  <h2 id="classTitle">Loading classroom...</h2>

 <!-- === Marks Section === -->
<section class="card">
  <h3>Enter Student Marks</h3>

  <!-- Exam Selection -->
  <select id="examSelect">
    <option value="">-- Select Exam --</option>
    <option>PeriodicTest1</option>
    <option>HalfYearly</option>
    <option>PeriodicTest3</option>
    <option>Annual</option>
  </select>

  <!-- Area to Add Marks -->
  <div id="marksArea"></div>

  <!-- Add Student Input -->
  <input id="studentName" placeholder="Student name">
  <button class="btn" id="addStudentBtn">Add Student</button>

  <!-- Save Marks -->
  <button class="btn" id="saveMarksBtn">Save Marks</button>

  <!-- üìä Marks Chart Canvas -->
  <div style="margin-top:20px;">
    <canvas id="marksChart" width="400" height="200"></canvas>
  </div>

  <!-- üìà Marks Analytics -->
  <div id="marksAnalytics" style="margin-top:10px;"></div>
</section>

  <!-- === Timetable === -->
  <section class="card">
    <h3>Timetable (8 periods + Lunch after 4th)</h3>
    <div id="timetableArea"></div>
    <button class="btn" id="saveTimetableBtn">Save Timetable</button>
  </section>

  <!-- === Attendance === -->
  <section class="card">
    <h3>Attendance</h3>
    <div id="attendanceArea"></div>
    <button class="btn" id="saveAttendanceBtn">Save Attendance</button>
  </section>

  <!-- === Photos === -->
  <section class="card">
    <h3>Class Activity Photos</h3>
    <input type="file" id="activityPhoto" multiple accept="image/*">
    <button class="btn" id="uploadPhotoBtn">Upload</button>
    <div id="photoGallery"></div>
  </section>
</main>

<script>
  // === Get class name ===
  const params = new URLSearchParams(window.location.search);
  const className = params.get("class") || "Unknown";
  document.getElementById("classTitle").innerText = "Classroom: " + className;

  // === Firebase References ===
  const marksRef = db.ref(`schools/dilasagram/classes/${className}/marks`);
  const complaintsRef = db.ref(`schools/dilasagram/classes/${className}/complaints`);
  const timetableRef = db.ref(`schools/dilasagram/classes/${className}/timetable`);
  const attendanceRef = db.ref(`schools/dilasagram/classes/${className}/attendance`);
  const activityRef = db.ref(`schools/dilasagram/classes/${className}/activities`);
  
  /* === 1Ô∏è‚É£ MARKS SECTION === */
  const studentList = []; // store names to use for attendance
  
  document.getElementById("addStudentBtn").onclick = () => {
    const name = document.getElementById("studentName").value.trim();
    if (!name) return alert("Enter student name");
    studentList.push(name);
    const div = document.createElement("div");
    div.innerHTML = `
      <h4>${name}</h4>
      <input type="number" placeholder="English" id="${name}-English">
      <input type="number" placeholder="Maths" id="${name}-Maths">
      <input type="number" placeholder="Science" id="${name}-Science">
      <input type="number" placeholder="SocialScience" id="${name}-SS">
      <input type="number" placeholder="Hindi" id="${name}-Hindi">
      <input type="number" placeholder="Marathi" id="${name}-Marathi">
    `;
    document.getElementById("marksArea").appendChild(div);
    document.getElementById("studentName").value = "";
  };

  document.getElementById("saveMarksBtn").onclick = () => {
    const exam = document.getElementById("examSelect").value;
    if (!exam) return alert("Select exam");
    const inputs = document.querySelectorAll("#marksArea input");
    const data = {};
    inputs.forEach(inp => {
      const [student, subj] = inp.id.split("-");
      data[student] = data[student] || {};
      data[student][subj] = parseInt(inp.value) || 0;
    });
   marksRef.child(exam).set(data, (err) => {
  if (err) alert("‚ùå Failed to save marks");
  else {
    alert("Marks saved successfully ‚úÖ");
    renderAnalytics(data);
    renderMarksChart(data, exam);
  }
});
  };

  // === Marks % Analytics ===
  function renderAnalytics(data) {
    let html = "<h4>üìä Marks Analytics</h4>";
    let totalPerc = 0, count = 0;
    for (let student in data) {
      const subs = Object.values(data[student]);
      const total = subs.reduce((a, b) => a + b, 0);
      const percent = (total / (subs.length * 100)) * 100;
      totalPerc += percent; count++;
      html += `<p><b>${student}</b>: ${percent.toFixed(2)}%</p>`;
    }
    if (count > 0) html += `<p><b>Class Average:</b> ${(totalPerc / count).toFixed(2)}%</p>`;
    document.getElementById("marksArea").insertAdjacentHTML("beforeend", html);
  }
  // === Chart.js Graph ===
let marksChart;

function renderMarksChart(data, examName) {
  const ctx = document.getElementById("marksChart").getContext("2d");

  const students = Object.keys(data);
  const averages = students.map(name => {
    const subs = Object.values(data[name]);
    const total = subs.reduce((a, b) => a + b, 0);
    return (total / (subs.length * 100)) * 100;
  });

  // Destroy old chart if exists
  if (marksChart) marksChart.destroy();

  marksChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: students,
      datasets: [{
        label: `${examName} %`,
        data: averages,
        backgroundColor: students.map(() => `hsl(${Math.random() * 360},70%,60%)`)
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          max: 100
        }
      },
      plugins: {
        title: {
          display: true,
          text: `üìä ${examName} Marks Percentage`
        },
        legend: {
          display: false
        }
      }
    }
  });
}


  /* === 2Ô∏è‚É£ COMPLAINTS === */
  document.getElementById("submitComplaintBtn").onclick = () => {
    const teacher = document.getElementById("teacherName").value;
    const text = document.getElementById("complaintText").value;
    if (!teacher || !text) return alert("Please fill both fields");
    complaintsRef.push({
      teacher, text,
      time: new Date().toLocaleString(),
      status: "Unresolved"
    });
    alert("Complaint submitted ‚úÖ");
    document.getElementById("teacherName").value = "";
    document.getElementById("complaintText").value = "";
  };

  // === Complaint Table with Delete and Status ===
  const complaintCard = document.querySelector(".card:nth-of-type(2)");
  const complaintTable = document.createElement("div");
  complaintCard.appendChild(complaintTable);

  complaintsRef.on("value", (snap) => {
    const data = snap.val() || {};
    let html = "<h4>Existing Complaints</h4>";
    html += "<table border='1' style='width:100%;border-collapse:collapse;'>";
    html += "<tr><th>Teacher</th><th>Complaint</th><th>Status</th><th>Action</th></tr>";
    for (let id in data) {
      const c = data[id];
      html += `<tr>
        <td>${c.teacher}</td>
        <td>${c.text}</td>
        <td>${c.status}</td>
        <td>
          <button onclick="markResolved('${id}')">Resolve</button>
          <button onclick="deleteComplaint('${id}')">Delete</button>
        </td>
      </tr>`;
    }
    html += "</table>";
    complaintTable.innerHTML = html;
  });

  function markResolved(id) {
    complaintsRef.child(id).update({ status: "Resolved" });
  }

  function deleteComplaint(id) {
    complaintsRef.child(id).remove();
  }

  /* === 3Ô∏è‚É£ TIMETABLE === */
  const timetableArea = document.getElementById("timetableArea");
  const periods = ["1","2","3","4","Lunch","5","6","7","8"];
  periods.forEach(p => {
    const div = document.createElement("div");
    div.innerHTML = `<input placeholder="${p==='Lunch'?'Lunch Break':'Period ' + p}" id="period${p}">`;
    timetableArea.appendChild(div);
  });

  document.getElementById("saveTimetableBtn").onclick = () => {
    const updates = {};
    periods.forEach(p => {
      updates[`period${p}`] = document.getElementById(`period${p}`).value || "";
    });
    timetableRef.set(updates);
    alert("Timetable saved ‚úÖ");
  };

  /* === 4Ô∏è‚É£ ATTENDANCE === */
  const attArea = document.getElementById("attendanceArea");
  function renderAttendance() {
    attArea.innerHTML = "";
    studentList.forEach((name, i) => {
      const div = document.createElement("div");
      div.innerHTML = `<label>${i+1}. ${name} <input type="checkbox" id="att-${name}"></label>`;
      attArea.appendChild(div);
    });
  }

  document.getElementById("saveAttendanceBtn").onclick = () => {
    const data = {};
    studentList.forEach(name => {
      data[name] = document.getElementById("att-" + name)?.checked ? "Present" : "Absent";
    });
    attendanceRef.child(new Date().toISOString().split("T")[0]).set(data);
    alert("Attendance saved ‚úÖ");
  };

  /* === 5Ô∏è‚É£ FIXED PHOTO UPLOAD === */
  const fileInput = document.getElementById("activityPhoto");
  const gallery = document.getElementById("photoGallery");

  document.getElementById("uploadPhotoBtn").onclick = async () => {
    const files = fileInput.files;
    if (!files.length) return alert("Select images first");

    for (let f of files) {
      const ref = storage.ref(`activities/${className}/${f.name}`);
      await ref.put(f);
      const url = await ref.getDownloadURL();

      // Save inside class
      await activityRef.push({ url, name: f.name, time: new Date().toLocaleString() });
      // Save in public gallery
      await db.ref(`schools/dilasagram/public/gallery`).push({
        url,
        name: f.name,
        uploadedBy: className,
        time: new Date().toLocaleString()
      });
    }

    alert("Photos uploaded ‚úÖ");
  };

  activityRef.on("value", snap => {
    const data = snap.val() || {};
    gallery.innerHTML = "";
    Object.values(data).forEach(p => {
      const img = document.createElement("img");
      img.src = p.url;
      img.style = "width:100px;border-radius:10px;margin:5px;";
      gallery.appendChild(img);
    });
  });
</script>
  
  <footer class="footer"><a href="index.html" class="btn">Logout</a></footer>
</body>
</html>







